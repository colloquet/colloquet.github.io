<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>iReserve</title>

    <link href="/favicon.ico" rel="shortcut icon">

    <!-- link all the styles -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/uikit/2.27.1/css/uikit.almost-flat.min.css" />

    <!-- HTML5 Shiv and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <style>
      .none {
        background: #fff1f0;
        color: #d85030;
      }

      .all {
        background: #f2fae3;
        color: #659f13;
      }
    </style>

  </head>
  <body>
    <div id="app" class="uk-container uk-container-center uk-margin-top">
      <h1>iReserve ({{ date }})</h1>

      <div class="uk-overflow-container">
        <table class="uk-table">
          <thead>
            <tr>
              <th></th>
              <th>香港, Canton Road</th>
              <th>香港, Causeway Bay</th>
              <th>香港, Festival Walk</th>
              <th>香港, ifc mall</th>
              <th>香港, New Town Plaza</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="model in models">
              <td>
                <span class="uk-icon-button uk-icon-volume-off" v-show="!model.notification" @click="model.notification = true"></span>
                <span class="uk-icon-button uk-icon-volume-up" v-show="model.notification" @click="model.notification = false"></span>
                <span class="uk-margin-left">{{ model.label }}</span>
              </td>
              <td :class="getClass(r499[model.modelNumber])">{{ r499[model.modelNumber] || '-' }}</td>
              <td :class="getClass(r409[model.modelNumber])">{{ r409[model.modelNumber] || '-' }}</td>
              <td :class="getClass(r485[model.modelNumber])">{{ r485[model.modelNumber] || '-' }}</td>
              <td :class="getClass(r428[model.modelNumber])">{{ r428[model.modelNumber] || '-' }}</td>
              <td :class="getClass(r610[model.modelNumber])">{{ r610[model.modelNumber] || '-' }}</td>
            </tr>
          </tbody>
        </table>

        <button class="uk-button" @click="startAutoRefresh" v-show="!autoRefresh">Start auto refresh</button>
        <button class="uk-button" @click="stopAutoRefresh" v-show="autoRefresh">Stop auto refresh</button>

        <div class="uk-float-right">
          <p class="uk-text-muted uk-text-right">
            <span>Last updated: {{ lastUpdated || '-' }}</span><br>
            To get data from Apple you need to install this <a href="https://chrome.google.com/webstore/detail/cors-toggle/omcncfnpmcabckcddookmnajignpffnh?hl=zh-TW" target="_blank">Chrome extension</a>.
          </p>
        </div>
      </div>
    </div>

    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/vue/2.0.0-rc.5/vue.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/vue-resource/1.0.1/vue-resource.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.14.1/moment.min.js"></script>
    <script>
    var vm = new Vue({
      el: "#app",
      data: {
        date: {},
        r499: {},
        r409: {},
        r485: {},
        r428: {},
        r610: {},
        autoRefresh: true,
        isLoading: false,
        timer: null,
        lastUpdated: null,
        models: [
          {
            modelNumber: "MNQL2ZP/A",
            label: "iPhone 7 Plus (32GB) 玫瑰金色",
            notification: false,
          },
          {
            modelNumber: "MNQK2ZP/A",
            label: "iPhone 7 Plus (32GB) 金色",
            notification: false,
          },
          {
            modelNumber: "MNQJ2ZP/A",
            label: "iPhone 7 Plus (32GB) 銀色",
            notification: false,
          },
          {
            modelNumber: "MN4D2ZP/A",
            label: "iPhone 7 Plus (32GB) 亮黑色",
            notification: false,
          },
          {
            modelNumber: "MN4C2ZP/A",
            label: "iPhone 7 Plus (128GB) 玫瑰金色",
            notification: false,
          },
          {
            modelNumber: "MN4A2ZP/A",
            label: "iPhone 7 Plus (128GB) 金色",
            notification: false,
          },
          {
            modelNumber: "MN492ZP/A",
            label: "iPhone 7 Plus (128GB) 銀色",
            notification: false,
          },
          {
            modelNumber: "MN482ZP/A",
            label: "iPhone 7 Plus (128GB) 黑色",
            notification: false,
          },
          {
            modelNumber: "MN4D2ZP/A",
            label: "iPhone 7 Plus (128GB) 亮黑色",
            notification: false,
          },
          {
            modelNumber: "MN4K2ZP/A",
            label: "iPhone 7 Plus (256GB) 玫瑰金色",
            notification: false,
          },
          {
            modelNumber: "MN4J2ZP/A",
            label: "iPhone 7 Plus (256GB) 金色",
            notification: false,
          },
          {
            modelNumber: "MN4F2ZP/A",
            label: "iPhone 7 Plus (256GB) 銀色",
            notification: false,
          },
          {
            modelNumber: "MN4E2ZP/A",
            label: "iPhone 7 Plus (256GB) 黑色",
            notification: false,
          },
          {
            modelNumber: "MN4L2ZP/A",
            label: "iPhone 7 Plus (256GB) 亮黑色",
            notification: false,
          },
        ]
      },
      methods: {
        getJSON: function() {
          this.isLoading = true;

          this.$http.get('https://reserve.cdn-apple.com/HK/zh_HK/reserve/iPhone/availability.json').then((response) => {
            var data = response.body;

            this.date = data.zh_HK.launchDate;
            this.r499 = data['R499'];
            this.r409 = data['R409'];
            this.r485 = data['R485'];
            this.r428 = data['R428'];
            this.r610 = data['R610'];

            this.lastUpdated = moment().format('h:mm:ssa');

            this.isLoading = false;
          }, (response) => {
            alert('ERROR: Could not get data, make sure you have installed and turned on the extension.');
            this.autoRefresh = false;
          });
        },
        getClass: function(status) {
          switch (status) {
            case 'NONE':
              return 'none';
              break;
            case 'ALL':
              return 'all';
              break;
            default:
              return 'none';
          }
        },
        startAutoRefresh: function() {
          var self = this;

          self.autoRefresh = true;
          self.timer = setInterval(function() {
            if (!self.isLoading && self.autoRefresh) {
              self.getJSON();
            }
          }, 5000);
        },
        stopAutoRefresh: function() {
          this.autoRefresh = false;

          clearInterval(this.timer);
        }
      },
      watch: {
        "r499": function(value) {
          this.models.forEach(function(model) {
            if (value[model.modelNumber] != 'NONE' && model.notification) {
              var notification = new Notification('iReserve', {
                body: model.label + " is available at 香港, Canton Road!",
              });

              notification.onclick = function () {
                window.open("https://reserve-hk.apple.com/HK/zh_HK/reserve/iPhone?partNumber=" + model.modelNumber.replace("/", "%2F") + "&channel=1&rv=&path=&sourceID=&iPP=false&appleCare=&iUID=&iuToken=&carrier=&store=R499");
              };
            }
          });
        },
        "r409": function(value) {
          this.models.forEach(function(model) {
            if (value[model.modelNumber] != 'NONE' && model.notification) {
              var notification = new Notification('iReserve', {
                body: model.label + " is available at 香港, Causeway Bay!",
              });

              notification.onclick = function () {
                window.open("https://reserve-hk.apple.com/HK/zh_HK/reserve/iPhone?partNumber=" + model.modelNumber.replace("/", "%2F") + "&channel=1&rv=&path=&sourceID=&iPP=false&appleCare=&iUID=&iuToken=&carrier=&store=R409");
              };
            }
          });
        },
        "r485": function(value) {
          this.models.forEach(function(model) {
            if (value[model.modelNumber] != 'NONE' && model.notification) {
              var notification = new Notification('iReserve', {
                body: model.label + " is available at 香港, Festival Walk!",
              });

              notification.onclick = function () {
                window.open("https://reserve-hk.apple.com/HK/zh_HK/reserve/iPhone?partNumber=" + model.modelNumber.replace("/", "%2F") + "&channel=1&rv=&path=&sourceID=&iPP=false&appleCare=&iUID=&iuToken=&carrier=&store=R485");
              };
            }
          });
        },
        "r428": function(value) {
          this.models.forEach(function(model) {
            if (value[model.modelNumber] != 'NONE' && model.notification) {
              var notification = new Notification('iReserve', {
                body: model.label + " is available at 香港, ifc mall!",
              });

              notification.onclick = function () {
                window.open("https://reserve-hk.apple.com/HK/zh_HK/reserve/iPhone?partNumber=" + model.modelNumber.replace("/", "%2F") + "&channel=1&rv=&path=&sourceID=&iPP=false&appleCare=&iUID=&iuToken=&carrier=&store=R428");
              };
            }
          });
        },
        "r610": function(value) {
          this.models.forEach(function(model) {
            if (value[model.modelNumber] != 'NONE' && model.notification) {
              var notification = new Notification('iReserve', {
                body: model.label + " is available at 香港, New Town Plaza!",
              });

              notification.onclick = function () {
                window.open("https://reserve-hk.apple.com/HK/zh_HK/reserve/iPhone?partNumber=" + model.modelNumber.replace("/", "%2F") + "&channel=1&rv=&path=&sourceID=&iPP=false&appleCare=&iUID=&iuToken=&carrier=&store=R610");
              };
            }
          });
        },
      },
      mounted: function() {
        if (Notification.permission !== "granted")
          Notification.requestPermission();

        this.getJSON();
        this.startAutoRefresh();
      }
    })
    </script>
  </body>
</html>
