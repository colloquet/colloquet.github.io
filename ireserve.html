<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>iReserve Monitor</title>

    <link href="/favicon.ico" rel="shortcut icon">

    <!-- link all the styles -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/uikit/2.27.1/css/uikit.almost-flat.min.css" />

    <!-- HTML5 Shiv and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <style>
      .none {
        position: relative;
        background: #fff1f0;
        color: #d85030;
      }

      .all {
        position: relative;
        background: #f2fae3;
        color: #659f13;
      }

      .table-cell-link {
        display: block;
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
      }
    </style>

  </head>
  <body>
    <div id="app" class="uk-container uk-container-center uk-margin-top">
      <h1>iReserve ({{ date }})</h1>

      <div class="uk-overflow-container">
        <table class="uk-table">
          <thead>
            <tr>
              <th></th>
              <th>Canton Road</th>
              <th>Causeway Bay</th>
              <th>Festival Walk</th>
              <th>ifc mall</th>
              <th>New Town Plaza</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="model in models">
              <td class="uk-text-nowrap">
                <span class="uk-icon-button uk-icon-volume-off" v-show="!model.notification" @click="model.notification = true"></span>
                <span class="uk-icon-button uk-icon-volume-up" v-show="model.notification" @click="model.notification = false"></span>
                <img :src="images[model.color]" alt="" width="20" class="uk-margin-left">
                <span class="uk-margin-left uk-text-truncate">{{ model.label }}</span>
              </td>
              <td :class="getClass(r499[model.modelNumber])">{{ r499[model.modelNumber] || '-' }} <a :href="getLink(model.modelNumber, 'R499')" target="_blank" class="table-cell-link" v-show="r499[model.modelNumber] != 'NONE'"></a></td>
              <td :class="getClass(r409[model.modelNumber])">{{ r409[model.modelNumber] || '-' }} <a :href="getLink(model.modelNumber, 'R409')" target="_blank" class="table-cell-link" v-show="r409[model.modelNumber] != 'NONE'"></a></td>
              <td :class="getClass(r485[model.modelNumber])">{{ r485[model.modelNumber] || '-' }} <a :href="getLink(model.modelNumber, 'R485')" target="_blank" class="table-cell-link" v-show="r485[model.modelNumber] != 'NONE'"></a></td>
              <td :class="getClass(r428[model.modelNumber])">{{ r428[model.modelNumber] || '-' }} <a :href="getLink(model.modelNumber, 'R428')" target="_blank" class="table-cell-link" v-show="r428[model.modelNumber] != 'NONE'"></a></td>
              <td :class="getClass(r610[model.modelNumber])">{{ r610[model.modelNumber] || '-' }} <a :href="getLink(model.modelNumber, 'R610')" target="_blank" class="table-cell-link" v-show="r610[model.modelNumber] != 'NONE'"></a></td>
            </tr>
          </tbody>
        </table>

        <button class="uk-button" @click="startAutoRefresh" v-show="!autoRefresh">Start auto refresh</button>
        <button class="uk-button" @click="stopAutoRefresh" v-show="autoRefresh">Stop auto refresh</button>

        <div class="uk-float-right">
          <p class="uk-text-muted uk-text-right">
            <span>Last updated: {{ lastUpdated || '-' }}</span><br>
            To get data from Apple you need to install this <a href="https://chrome.google.com/webstore/detail/cors-toggle/omcncfnpmcabckcddookmnajignpffnh?hl=zh-TW" target="_blank">Chrome extension</a>.
          </p>
        </div>
      </div>
    </div>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-51297067-1', 'auto');
      ga('send', 'pageview');

    </script>

    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/vue/2.0.0-rc.5/vue.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/vue-resource/1.0.1/vue-resource.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.14.1/moment.min.js"></script>
    <script>
    var vm = new Vue({
      el: "#app",
      data: {
        date: {},
        r499: {},
        r409: {},
        r485: {},
        r428: {},
        r610: {},
        autoRefresh: true,
        isLoading: false,
        timer: null,
        lastUpdated: null,
        images: {
          roseGold: "https://store.storeimages.cdn-apple.com/4973/as-images.apple.com/is/image/AppleInc/aos/published/images/i/ph/iphone7/plus/iphone7-plus-rosegold-select-2016_AV2?wid=78&qlt=95&.v=1471567471062&fmt=png-alpha",
          gold: "https://store.storeimages.cdn-apple.com/4973/as-images.apple.com/is/image/AppleInc/aos/published/images/i/ph/iphone7/plus/iphone7-plus-gold-select-2016_AV2?wid=78&qlt=95&.v=1471567408566&fmt=png-alpha",
          silver: "https://store.storeimages.cdn-apple.com/4973/as-images.apple.com/is/image/AppleInc/aos/published/images/i/ph/iphone7/plus/iphone7-plus-silver-select-2016_AV2?wid=78&qlt=95&.v=1471567499972&fmt=png-alpha",
          black: "https://store.storeimages.cdn-apple.com/4973/as-images.apple.com/is/image/AppleInc/aos/published/images/i/ph/iphone7/plus/iphone7-plus-black-select-2016_AV2?wid=78&qlt=95&.v=1471567373453&fmt=png-alpha",
          jetBlack: "https://store.storeimages.cdn-apple.com/4973/as-images.apple.com/is/image/AppleInc/aos/published/images/i/ph/iphone7/plus/iphone7-plus-jetblack-select-2016_AV2?wid=78&qlt=95&.v=1471567438056&fmt=png-alpha"
        },
        models: [
          {
            modelNumber: "MNQL2ZP/A",
            label: "iPhone 7 Plus (32GB) 玫瑰金色",
            notification: false,
            color: "roseGold"
          },
          {
            modelNumber: "MNQK2ZP/A",
            label: "iPhone 7 Plus (32GB) 金色",
            notification: false,
            color: "gold"
          },
          {
            modelNumber: "MNQJ2ZP/A",
            label: "iPhone 7 Plus (32GB) 銀色",
            notification: false,
            color: "silver"
          },
          {
            modelNumber: "MN4D2ZP/A",
            label: "iPhone 7 Plus (32GB) 黑色",
            notification: false,
            color: "black"
          },
          {
            modelNumber: "MN4C2ZP/A",
            label: "iPhone 7 Plus (128GB) 玫瑰金色",
            notification: false,
            color: "roseGold"
          },
          {
            modelNumber: "MN4A2ZP/A",
            label: "iPhone 7 Plus (128GB) 金色",
            notification: false,
            color: "gold"
          },
          {
            modelNumber: "MN492ZP/A",
            label: "iPhone 7 Plus (128GB) 銀色",
            notification: false,
            color: "silver"
          },
          {
            modelNumber: "MN482ZP/A",
            label: "iPhone 7 Plus (128GB) 黑色",
            notification: false,
            color: "black"
          },
          {
            modelNumber: "MN4D2ZP/A",
            label: "iPhone 7 Plus (128GB) 亮黑色",
            notification: false,
            color: "jetBlack"
          },
          {
            modelNumber: "MN4K2ZP/A",
            label: "iPhone 7 Plus (256GB) 玫瑰金色",
            notification: false,
            color: "roseGold"
          },
          {
            modelNumber: "MN4J2ZP/A",
            label: "iPhone 7 Plus (256GB) 金色",
            notification: false,
            color: "gold"
          },
          {
            modelNumber: "MN4F2ZP/A",
            label: "iPhone 7 Plus (256GB) 銀色",
            notification: false,
            color: "silver"
          },
          {
            modelNumber: "MN4E2ZP/A",
            label: "iPhone 7 Plus (256GB) 黑色",
            notification: false,
            color: "black"
          },
          {
            modelNumber: "MN4L2ZP/A",
            label: "iPhone 7 Plus (256GB) 亮黑色",
            notification: false,
            color: "jetBlack"
          },
        ]
      },
      methods: {
        getJSON: function() {
          this.isLoading = true;

          this.$http.get('https://reserve.cdn-apple.com/HK/zh_HK/reserve/iPhone/availability.json').then((response) => {
            var data = response.body;

            this.date = data.zh_HK.launchDate;
            this.r499 = data['R499'];
            this.r409 = data['R409'];
            this.r485 = data['R485'];
            this.r428 = data['R428'];
            this.r610 = data['R610'];

            this.lastUpdated = moment().format('h:mm:ssa');

            this.isLoading = false;
          }, (response) => {
            alert('ERROR: Could not get data, make sure you have installed and turned on the extension.');
            this.autoRefresh = false;
          });
        },
        getClass: function(status) {
          switch (status) {
            case 'NONE':
              return 'none';
              break;
            case 'ALL':
              return 'all';
              break;
            default:
              return 'none';
          }
        },
        getLink: function(modelNumber, location) {
          return "https://reserve-hk.apple.com/HK/zh_HK/reserve/iPhone?partNumber=" + modelNumber.replace("/", "%2F") + "&channel=1&rv=&path=&sourceID=&iPP=false&appleCare=&iUID=&iuToken=&carrier=&store=" + location;
        },
        startAutoRefresh: function() {
          var self = this;

          self.autoRefresh = true;
          self.timer = setInterval(function() {
            if (!self.isLoading && self.autoRefresh) {
              self.getJSON();
            }
          }, 5000);
        },
        stopAutoRefresh: function() {
          this.autoRefresh = false;

          clearInterval(this.timer);
        }
      },
      watch: {
        "r499": function(value) {
          this.models.forEach(function(model) {
            if (value[model.modelNumber] != 'NONE' && model.notification) {
              var notification = new Notification('iReserve', {
                body: model.label + " is available at 香港, Canton Road!",
              });

              notification.onclick = function () {
                window.open("https://reserve-hk.apple.com/HK/zh_HK/reserve/iPhone?partNumber=" + model.modelNumber.replace("/", "%2F") + "&channel=1&rv=&path=&sourceID=&iPP=false&appleCare=&iUID=&iuToken=&carrier=&store=R499");
              };
            }
          });
        },
        "r409": function(value) {
          this.models.forEach(function(model) {
            if (value[model.modelNumber] != 'NONE' && model.notification) {
              var notification = new Notification('iReserve', {
                body: model.label + " is available at 香港, Causeway Bay!",
              });

              notification.onclick = function () {
                window.open("https://reserve-hk.apple.com/HK/zh_HK/reserve/iPhone?partNumber=" + model.modelNumber.replace("/", "%2F") + "&channel=1&rv=&path=&sourceID=&iPP=false&appleCare=&iUID=&iuToken=&carrier=&store=R409");
              };
            }
          });
        },
        "r485": function(value) {
          this.models.forEach(function(model) {
            if (value[model.modelNumber] != 'NONE' && model.notification) {
              var notification = new Notification('iReserve', {
                body: model.label + " is available at 香港, Festival Walk!",
              });

              notification.onclick = function () {
                window.open("https://reserve-hk.apple.com/HK/zh_HK/reserve/iPhone?partNumber=" + model.modelNumber.replace("/", "%2F") + "&channel=1&rv=&path=&sourceID=&iPP=false&appleCare=&iUID=&iuToken=&carrier=&store=R485");
              };
            }
          });
        },
        "r428": function(value) {
          this.models.forEach(function(model) {
            if (value[model.modelNumber] != 'NONE' && model.notification) {
              var notification = new Notification('iReserve', {
                body: model.label + " is available at 香港, ifc mall!",
              });

              notification.onclick = function () {
                window.open("https://reserve-hk.apple.com/HK/zh_HK/reserve/iPhone?partNumber=" + model.modelNumber.replace("/", "%2F") + "&channel=1&rv=&path=&sourceID=&iPP=false&appleCare=&iUID=&iuToken=&carrier=&store=R428");
              };
            }
          });
        },
        "r610": function(value) {
          this.models.forEach(function(model) {
            if (value[model.modelNumber] != 'NONE' && model.notification) {
              var notification = new Notification('iReserve', {
                body: model.label + " is available at 香港, New Town Plaza!",
              });

              notification.onclick = function () {
                window.open("https://reserve-hk.apple.com/HK/zh_HK/reserve/iPhone?partNumber=" + model.modelNumber.replace("/", "%2F") + "&channel=1&rv=&path=&sourceID=&iPP=false&appleCare=&iUID=&iuToken=&carrier=&store=R610");
              };
            }
          });
        },
      },
      mounted: function() {
        if (Notification.permission !== "granted")
          Notification.requestPermission();

        this.getJSON();
        this.startAutoRefresh();
      }
    })
    </script>
  </body>
</html>
