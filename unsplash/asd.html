<!DOCTYPE html>
 
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>imgur oauth</title>
    <script src="http://html2canvas.hertzen.com/build/html2canvas.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script>
      $(function () {
        var extractToken = function(hash) {
          var match = hash.match(/access_token=(\w+)/);
          return !!match && match[1];
        };
 
        var $post = $('.post');
        var $msg = $('.hidden');
        var $img = $('#pic');
 
        $post.click(function() {
          localStorage.doUpload = true;
          localStorage.imageBase64 = $('#pic').attr('src');
        });
 
        var token = extractToken(document.location.hash);
        if (token && JSON.parse(localStorage.doUpload)) {
          localStorage.doUpload = false;
 
          $.ajax({
            url: 'https://api.imgur.com/3/image',
            method: 'POST',
            headers: {
              Authorization: 'Bearer ' + $token,
              Accept: 'application/json'
            },
            data: {
              image: localStorage.imageBase64,
              type: 'base64'
            },
            success: function(result) {
              var id = result.data.id;
              window.location = 'https://imgur.com/gallery/' + id;
            }
          });
        }
      });
      function genCan() {
        var rand = Math.floor(Math.random() * (6 - 0 + 1)) + 0;
        var bg = "<img src='"+rand+".jpeg'>";
        $("#mydiv img").replaceWith(bg);
        $("#mydiv p").text($("#line").val());
        $('#image').html("Loading...");
        html2canvas([document.getElementById('mydiv')], {
            onrendered: function (canvas) {
                $('#canvas').html(canvas);
                var data = canvas.toDataURL('image/png');
                // AJAX call to send `data` to a PHP file that creates an image from the dataURI string and saves it to a directory on the server

                var image = new Image();
                image.src = data;
                $('#image').html("<img id='pic' src='"+data+"'>");
                $('#download').html("<a href='"+data+"' download='image.png'>Download</a>");
            }, useCORS: true
        });
      };
      function share() {

        var extractToken = function(hash) {
          var match = hash.match(/access_token=(\w+)/);
          return !!match && match[1];
        };
        var asd = $('#pic').attr('src').replace(/.*,/, '');
        var token = extractToken(document.location.hash);
        alert(asd);
        $.ajax({ 
          url: 'https://api.imgur.com/3/image',
          headers: {
              Authorization: 'Bearer ' + token,
              Accept: 'application/json'
          },
          type: 'POST',
          data: {
              'image': asd,
              type: 'base64'
          },
          success: function() { console.log('cool'); }
      });
      }
    </script>
    <style>
      #mydiv {
        width: 200px;
        height: 200px;
        position: relative;

      }
      #mydiv img {
        height: 200px;
        width: 200px;
        z-index: -1;
        position: absolute;
      }
      #overlay {
        position: absolute;
        left: 0;
        top: 0;
        background: rgba(0,0,0,.5);
        width: 100%;
        height: 100%;
        z-index: 0;
      }
      #mydiv p {
        position: relative;
        z-index: 2;
        color: #fff;
      }
    </style>
  </head>
 
  <body>
    <div id="mydiv">
        <img src="" />
        <p>text!</p>
        <div id="overlay"></div>
    </div>
    <br>
    <br>
    <input type="text" name="line" id="line">
    <button id="genCanvas" onclick="genCan();">CANVAS</button>
    <!-- <p>Canvas:</p>
    <div id="canvas"></div> -->
        
    <p>Image:</p>
    <div id="image"></div>
    <div id="download"></div>
    <!-- <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAHElEQVQI12P4//8/w38GIAXDIBKE0DHxgljNBAAO9TXL0Y4OHwAAAABJRU5ErkJggg==" alt="Red dot"> -->
    <button id="test" class="post">test</button>
    <button onclick="share()">share</button>
    <a class="post" href="https://api.imgur.com/oauth2/authorize?response_type=token&client_id=61c01ad2d489738">Post image to imgur</a>
  </body>
</html>