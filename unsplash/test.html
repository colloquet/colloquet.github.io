<html>
<head>
	<script src="http://html2canvas.hertzen.com/build/html2canvas.js"></script>
	<script type="text/javascript" src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
	<style type="text/css">
		#mydiv {
		    width: 200px;
		    height: 200px;
		    position: relative;

		}
		#mydiv img {
			height: 200px;
			width: 200px;
			z-index: -1;
			position: absolute;
		}
		#overlay {
			position: absolute;
			left: 0;
			top: 0;
			background: rgba(0,0,0,.5);
			width: 100%;
			height: 100%;
			z-index: 0;
		}
		#mydiv p {
			position: relative;
			z-index: 2;
			color: #fff;
		}
	</style>
	<script type="text/javascript">
		$(function () {
	        var extractToken = function(hash) {
	          var match = hash.match(/access_token=(\w+)/);
	          return !!match && match[1];
	        };
	 
	        var $post = $('.post');
	        var $img = $('img');
	 
	        $post.click(function() {
	          localStorage.doUpload = true;
	          localStorage.imageBase64 = $img.attr('src').replace(/.*,/, '');
	        });
	 
	        var token = extractToken(document.location.hash);
	        if (token && JSON.parse(localStorage.doUpload)) {
	          localStorage.doUpload = false;
	          $post.hide();
	          $msg.show();
	 
	          $.ajax({
	            url: 'https://api.imgur.com/3/image',
	            method: 'POST',
	            headers: {
	              Authorization: 'Bearer ' + token,
	              Accept: 'application/json'
	            },
	            data: {
	              image: localStorage.imageBase64,
	              type: 'base64'
	            },
	            success: function(result) {
	              var id = result.data.id;
	              window.location = 'https://imgur.com/gallery/' + id;
	            }
	          });
	        }
	      });
		function genCan() {
			var rand = Math.floor(Math.random() * (6 - 0 + 1)) + 0;
			var bg = "<img src='"+rand+".jpeg'>";
			$("#mydiv img").replaceWith(bg);
			$("#mydiv p").text($("#line").val());
			$('#image').html("Loading...");
			html2canvas([document.getElementById('mydiv')], {
			    onrendered: function (canvas) {
			        // $('#canvas').html(canvas);
			        var data = canvas.toDataURL('image/png');
			        // AJAX call to send `data` to a PHP file that creates an image from the dataURI string and saves it to a directory on the server

			        var image = new Image();
			        image.src = data;
			        $('#image').html("<img src='"+data+"'>");
			        $('#download').html("<a href='"+data+"' download='image.png'>Download</a>");
			    }, useCORS: true
			});
		};

		function share(){
			html2canvas([document.getElementById('mydiv')], {
			    onrendered: function (canvas) {

			    var img;
			    try {
			        img = canvas.toDataURL('image/jpeg', 0.9).split(',')[1];
			    } catch(e) {
			        img = canvas.toDataURL().split(',')[1];
			    }
			    var w = window.open();
			    // w.document.write('Uploading to imgur.com...');
			    $.ajax({
			        url: 'https://api.imgur.com/3/image',
			        type: 'POST',
			        headers: {
			            Authorization: 'Client-ID 77a599373b0e695'
			        },
			        data: {
			            type: 'base64',
			            image: img
			        },
			        dataType: 'json'
			    }).success(function(result) {
			        var id = result.data.id;
			        window.location = 'https://imgur.com/gallery/' + id;
			    }).error(function() {
			        alert('Could not reach api.imgur.com. Sorry :(');
			    });
		    }
		});
		}
	</script>
</head>
<body>
<div id="mydiv">
    <img src="https://placehold.it/200x200" />
    <p>text!</p>
    <div id="overlay"></div>
</div>
<br>
<br>
<input type="text" name="line" id="line">
<button id="genCanvas" onclick="genCan();">CANVAS</button>
<!-- <p>Canvas:</p>
<div id="canvas"></div> -->
    
<p>Image:</p>
<div id="image"></div>
<div id="download"></div>
<a class="post" href="https://api.imgur.com/oauth2/authorize?response_type=token&client_id=77a599373b0e695">Post image to imgur</a>
<button id="share" onclick="share();">SHARE</button>

</body>
</html>